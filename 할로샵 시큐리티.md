# 3차 팀프로젝트 Haloshop 내파트 총정리 (시큐리티 중점)

## 1. 프로젝트 개요
- **내파트 :** 유저 + 보안 + 분석 + 마이페이지 + 관리자 + 로그 기능을 포함한 인증/보안 중심
- **기술 스택:** Spring Framework 2.7.x, Java 11, React, MySQL, AWS (로드밸런서, S3 등)
- **주요 목표:**  
  - 유저는 JWT 로그인 + bcrypt 암호화  
  - 관리자는 세션 로그인 + Argon2 암호화  
  - 두 인증 방식 혼용 + DB 기반 세션 및 JWT 블랙리스트 관리  
  - 이메일 기반 로그인 (username 아닌 email) + 커스텀 스프링 시큐리티 구현  
  - 관리자/유저 분리 테이블 설계 및 인증 API 분리  
  - 보안 강화 (2차 인증, IP 제한, 공격 탐지, 로그 암호화 등)  
  - AWS 인프라 환경에 맞춘 확장성 및 안정성 확보

---

## 2. DB 설계 (현재 확정 및 구상된 테이블)

| 테이블명               | 주요 역할 및 특징                                     |
|--------------------|----------------------------------------------|
| **account**           | 최상위 부모 테이블, 이메일 기반 공통 계정 정보 저장. <br> is_admin으로 유저/관리자 구분, 로그인 방식 분기 기준 |
| **user**              | 일반 유저 상세정보 (잔액, 주소, 생년월일 등) 저장, 1:1 관계 |
| **admin**             | 관리자 상세정보 (권한, 역할, 상위 관리자, 잠금 상태 등) 저장, 1:1 관계 |
| **user_status**       | 유저 상태 관리 (일반, 정지, 휴면, 삭제 등)                   |
| **social**            | 간편 로그인 종류 (google, kakao, apple 등)                 |
| **delete_users**      | 탈퇴 상태 유저 기록 (소프트 딜리트 후 자동 삭제 대비)           |
| **deleted_users_backup** | 하드 딜리트 된 유저 백업 (실수 복구용)                       |
| **logs**              | 유저 행동 및 보안 로그 기록 (블록체인 로그 시도 시 DB 삭제 예정)     |
| **jwt_blacklist**     | 로그아웃 및 무효화된 Refresh Token 저장용 블랙리스트 테이블          |
|**session** (아직 설계 못함)  | 세션 정보 저장 (중복로그인 방지+ 강제 로그아웃 기능(마스터 권한)     |
---

## 3. 인증 및 로그인 로직

- **유저 로그인:**  
  - 이메일(ID) + 비밀번호 입력 → bcrypt 해시 검증  
  - JWT Access Token + Refresh Token 발급 및 관리  
  - 로그아웃 시 Refresh Token 블랙리스트 등록  
  - 재로그인 시 기존 블랙리스트 토큰 삭제 → 정상 로그인 보장  

- **관리자 로그인:**  
  - 이메일(ID) + 비밀번호 입력 → Argon2 해시 검증  
  - 서버 세션 생성 및 DB/Redis에 저장 (세션 DB 관리 권장)  
  - 중복 로그인 차단 (한 계정 세션 1개 유지) 및 강제 로그아웃 기능 구현  

- **커스텀 스프링 시큐리티:**  
  - UserDetailsService 오버라이드하여 이메일 로그인 구현 혹은 커스텀 시큐리티 저번처럼 만들기
  - 인증 프로바이더에서 bcrypt/argon2 분기 처리  
  - 요청 경로에 따라 JWT 또는 세션 인증 필터 적용  

---

## 4. 보안 정책 및 인프라

- AWS 로드밸런서 + 오토스케일링 구성  
- 이미지 파일 AWS S3 업로드  
- IP 및 계정별 로그인 시도 제한, CAPTCHA 도입 가능  
- 로그 AES-GCM 대칭키 암호화 및 AWS KMS 키 관리  
- 2차 인증 선택적 적용 및 인센티브 설계  
- 보안 취약점 점검 자동화 (SAST/DAST + CI/CD)  

---

## 5. 향후 작업 및 고려 사항

- JWT + 세션 혼용 인증 완성 및 충분한 테스트  
- 이중 로그인 차단 로직 구현 (DB/Redis 토큰 매핑 관리)  
- 관리자/유저 API 분리 및 역할 기반 권한 검증 강화  
- 로그 관리 및 블록체인 연동 시나리오 구체화  
- 2차 인증 UX 완성 및 사용자 인센티브 제도 마련  
- 보안 테스트 및 취약점 대응 프로세스 정립

## 6. 추가 보안 고려 사항 (비밀번호 재설정 및 세션 관련)

### 비밀번호 재설정 과정 보안  
- 비밀번호 재설정 토큰은 반드시 **일회용**이고 **짧은 유효기간** 설정  
- 재설정 토큰 발급 시, 기존 인증 세션과 분리 처리  
- 토큰 탈취 방지를 위해 HTTPS, CSRF 토큰 적용 및 이메일 링크 검증 강화  
- 비밀번호 재설정 완료 시 관련 JWT 토큰(Access/Refresh)과 세션 즉시 무효화

### JWT 토큰 탈취 시나리오 대비  
- Access Token 탈취 시 피해 최소화를 위해 **짧은 만료 시간 설정**  
- Refresh Token은 안전하게 저장(예: HttpOnly 쿠키) 및 블랙리스트 관리  
- 로그인 시 기기 및 IP 체크로 이상행위 탐지  
- 의심스러운 로그인/토큰 사용 시 즉시 토큰 무효화 및 알림  

### 세션 하이재킹 대응  
- 세션 쿠키에 Secure, HttpOnly, SameSite 옵션 설정  
- 세션 ID 난수성 강화 및 세션 고정 공격 방지  
- 로그인 시 IP 및 User-Agent 변경 탐지 후 세션 무효화  
- 강제 로그아웃 기능(관리자 권한)을 통해 위협 시 즉각 세션 삭제 가능  


---
